name: Publish Packages

on:
  push:
    branches: [ main ]

jobs:
  verifychanges:
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.changed-domain-shared.outputs.changed }}
    
    steps:
    
    - name: Checkout 
      uses: actions/checkout@v2
      with:
        fetch-depth: 100 # avoid shallow clone so nbgv can do its work.

    - uses: marceloprado/has-changed-path@v1
      id: changed-domain-shared
      with:
        paths: AivenEcommerce.V1.Domain.Shared
        
      
  uploadnuget:
    needs: verifychanges
    runs-on: ubuntu-latest
   # if: needs.verifychanges.outputs.result == 'true'
    steps:
    - name: Checkout 
      uses: actions/checkout@v2
      
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1.7.2
      with:
        dotnet-version: 5.0.100
        
    - name: Install UpdateVersion
      run: dotnet tool install -g Monbsoft.UpdateVersion
      
    - name: Increment Patch Version
      working-directory: AivenEcommerce.V1.Domain.Shared
      run: update-version set  0.0.${{ github.run_number }}
    
    - name: Generate Package
      run: dotnet build AivenEcommerce.V1.Domain.Shared/AivenEcommerce.V1.Domain.Shared.csproj --configuration Release
    
    - name: Upload Nuget
      uses: tanaka-takayoshi/nuget-publish-to-github-packages-action@v2.1
      with:
        nupkg-path:  'AivenEcommerce.V1.Domain.Shared/bin/Release/*.nupkg'
        repo-owner:  'aivenweb'
        gh-user:  'aivenweb'
        token:  ${{ secrets.GH_AIVEN_TOKEN }}


    
